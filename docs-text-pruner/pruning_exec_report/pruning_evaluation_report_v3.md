# PruningEncoder性能評価レポート v3.0: 新評価データセットによる包括的検証

## 概要

本レポートは、新しい評価データセット`pruning-config/pruning_data_ja_v3.json`を用いて、17個のPruningEncoderモデル（基本11モデル＋item4(i4)6モデル）を再評価した結果です。v3データセットは、より多様なクエリとコンテキストを含み、モデルの汎化性能をより厳密に評価することを目的としています。

### 評価日時
- 2025年7月25日（pruning_data_ja_v3.jsonによる新規評価）

### 評価環境
- **評価スクリプト**: `scripts/pruning_exec.py`（混同行列・詳細メトリクス対応）
- **データセット**: `pruning-config/pruning_data_ja_v3.json`
  - 総クエリ数: 257（v2の188から36.7%増加）
  - 総コンテキスト数: 1,879（v2の1,396から34.6%増加）
  - 保持対象: 691コンテキスト（36.8%）
  - 削除対象: 1,188コンテキスト（63.2%）

### v3データセットの特徴
- より多様なドメインのクエリを含む
- 削除対象コンテキストの比率が増加（50.5%→63.2%）
- より実践的なRAGシステムの使用状況を反映

## 総合性能比較表（全17モデル）

| モデル | 最適閾値 | 圧縮率 | F2スコア | 精度 | 再現率 | 正解率 | TP | TN | FP | FN | 特徴 |
|--------|----------|--------|----------|------|--------|--------|----|----|----|----|------|
| **jpre-base-full-small-en** | 0.2 | 40.4% | **0.8752** | 60.7% | 98.4% | 75.9% | 680 | 747 | 441 | 11 | **最高F2** |
| **ruri-re310m-full-small-i4** | 0.6 | 42.3% | **0.8749** | 62.2% | 97.4% | 77.3% | 673 | 779 | 409 | 18 | **i4最高** |
| **jpre-base-msmarco-ja-small** | 0.3 | 44.0% | **0.8718** | 63.3% | 96.2% | 78.1% | 665 | 803 | 385 | 26 | **バランス** |
| **jpre-base-full-small** | 0.1 | 37.4% | 0.8704 | 58.5% | 99.1% | 73.8% | 685 | 702 | 486 | 6 | 高再現率 |
| **ruri-re310m-msmarco-ja-small** | 0.4 | 44.2% | 0.8677 | 64.3% | 95.1% | 78.8% | 657 | 823 | 365 | 34 | 高精度 |
| **ruri-re310m-full-all** | 0.7 | 53.2% | 0.8603 | 71.3% | 90.7% | **83.1%** | 627 | 935 | 253 | 64 | **最高圧縮** |
| **jpre-base-msmarco-ja-small-i4** | 0.5 | 34.3% | 0.8588 | 55.8% | 99.3% | 70.8% | 686 | 644 | 544 | 5 | i4高再現 |
| **jpre-base-full-small-i4** | 0.4 | 36.8% | 0.8550 | 56.9% | 97.8% | 71.9% | 676 | 675 | 513 | 15 | i4バランス |
| **jpre-xs-msmarco-ja-small** | 0.4 | 39.3% | 0.8475 | 57.2% | 96.4% | 72.1% | 666 | 689 | 499 | 25 | 軽量安定 |
| **jpre-base-full-all** | 0.3 | 44.1% | 0.8470 | 63.4% | 92.5% | 77.6% | 639 | 819 | 369 | 52 | 高効率 |
| **jpre-base-full-all-fixed** | 0.4 | 52.5% | 0.8236 | 66.6% | 87.6% | 79.2% | 605 | 884 | 304 | 86 | 高精度 |
| **jpre-xs-msmarco-ja-small-i4(新)** | 0.7 | 25.0% | 0.8239 | 48.9% | 99.4% | 61.6% | 687 | 470 | 718 | 4 | 最高再現 |
| **jpre-xs-full-small-i4** | 0.4 | 25.6% | 0.8219 | 49.0% | 99.0% | 61.7% | 684 | 475 | 713 | 7 | 軽量i4 |
| **jpre-xs-msmarco-ja-minimal** | 0.4 | 37.8% | 0.8037 | 54.1% | 91.5% | 68.3% | 632 | 652 | 536 | 59 | 基本型 |
| **jpre-xs-msmarco-ja-small-i4(旧)** | 0.45 | 13.1% | 0.7858 | 42.3% | **100%** | 49.9% | 691 | 246 | 942 | 0 | 極端保守 |
| **jpre-xs-full-all** | 0.4 | 74.9% | 0.2441 | 33.5% | 22.9% | 54.9% | 158 | 874 | 314 | 533 | 性能不良 |

## 主要な発見

### 1. データセットの影響

v2からv3への変更により、モデル性能に顕著な変化が見られました：

#### 性能向上したモデル
- **jpre-base-full-small-en**: F2スコアが維持され、v3でも最高性能
- **ruri-re310m-full-small-i4**: F2=0.8749で安定した高性能

#### 性能低下したモデル
- **jpre-xs-full-all**: 極端な性能低下（F2=0.2441、再現率22.9%）
- **jpre-xs-msmarco-ja-small-i4(旧)**: 精度が大幅低下（42.3%）

### 2. モデルアーキテクチャの傾向

#### ベースモデルサイズの影響
- **jpre-base系**: v3でも安定した高性能を維持
- **jpre-xs系**: 一部モデルで性能低下が顕著
- **ruri系**: 高い堅牢性を示し、データセット変更の影響が小さい

#### 学習データの影響
- **full-small-en（英語混合）**: 日本語データでも最高性能を達成
- **msmarco-ja-small**: バランスの取れた性能を維持
- **full-all**: 高圧縮率を実現

### 3. 圧縮率と性能のトレードオフ

| 圧縮率範囲 | 代表モデル | F2スコア範囲 | 特徴 |
|-----------|------------|--------------|------|
| 13-25% | jpre-xs-msmarco-ja-small-i4系 | 0.78-0.82 | 保守的、高再現率 |
| 34-44% | jpre-base系、ruri-small系 | 0.85-0.88 | バランス型、実用的 |
| 53-75% | ruri-full-all、jpre-xs-full-all | 0.24-0.86 | 高圧縮、性能差大 |

### 4. 混同行列から見る特性

#### 高再現率型（FN最小）
- **jpre-xs-msmarco-ja-small-i4(旧)**: FN=0（完璧）、ただしFP=942で実用性低
- **jpre-xs-msmarco-ja-small-i4(新)**: FN=4、バランス改善
- **jpre-base-msmarco-ja-small-i4**: FN=5、実用的

#### 高精度型（FP最小）
- **ruri-re310m-full-all**: FP=253、最高精度71.3%
- **jpre-base-full-all-fixed**: FP=304、精度66.6%

## 実用シナリオ別推奨（v3データ基準）

### シナリオ1: 最高性能重視（医療・金融・法務）
**推奨**: jpre-base-full-small-en（閾値0.2）
- F2スコア: 0.8752（最高）
- 再現率: 98.4%（FN=11のみ）
- 圧縮率: 40.4%（実用的）
- 英語データ混合学習による汎化性能

### シナリオ2: バランス重視（一般ビジネス）
**第1推奨**: ruri-re310m-full-small-i4（閾値0.6）
- F2スコア: 0.8749（第2位）
- 精度/再現率バランス: 62.2%/97.4%
- 圧縮率: 42.3%（効率的）

**第2推奨**: jpre-base-msmarco-ja-small（閾値0.3）
- F2スコア: 0.8718（第3位）
- 正解率: 78.1%（高い）
- 非i4モデルで安定性重視の場合

### シナリオ3: 高圧縮重視（大規模データ処理）
**推奨**: ruri-re310m-full-all（閾値0.7）
- 圧縮率: 53.2%（実用モデル中最高）
- F2スコア: 0.8603（高圧縮でも高性能）
- 正解率: 83.1%（全モデル中最高）

### シナリオ4: 情報保持最優先（アーカイブ・記録）
**推奨**: jpre-base-full-small（閾値0.1）
- 再現率: 99.1%（FN=6のみ）
- F2スコア: 0.8704
- 圧縮率: 37.4%（控えめだが実用的）

## v2からv3への移行における注意点

1. **閾値の再調整が必要**
   - データセット特性の変化により、最適閾値が変動する可能性
   - 本番環境では、実データでの閾値調整を推奨

2. **モデル選択の再検討**
   - jpre-xs-full-allのような極端な性能低下を示すモデルは避ける
   - ruri系モデルは安定性が高く、データセット変更に強い

3. **評価指標の解釈**
   - 削除対象比率の増加（50.5%→63.2%）により、圧縮率の意味が変化
   - F2スコアと実用性のバランスをより慎重に評価

## 技術的推奨事項

### 1. 本番環境での実装
```python
# v3データセット対応の推奨設定
RECOMMENDED_CONFIGS = {
    "highest_f2": {
        "model": "jpre-base-full-small-en",
        "threshold": 0.2,
        "expected_f2": 0.8752,
        "expected_compression": 0.404
    },
    "balanced": {
        "model": "ruri-re310m-full-small-i4",
        "threshold": 0.6,
        "expected_f2": 0.8749,
        "expected_compression": 0.423
    },
    "high_compression": {
        "model": "ruri-re310m-full-all",
        "threshold": 0.7,
        "expected_f2": 0.8603,
        "expected_compression": 0.532
    }
}
```

### 2. モニタリング指標
- **F2スコア**: 0.85以上を目標
- **再現率**: 95%以上を維持
- **圧縮率**: 用途に応じて20-50%の範囲で調整
- **FN（誤削除）**: 重要度に応じて許容値を設定

## 結論

pruning_data_ja_v3.jsonによる評価では、以下が明らかになりました：

1. **上位モデルの安定性**
   - jpre-base-full-small-en、ruri-re310m-full-small-i4は両データセットで高性能
   - 基本的なモデル選択指針は維持される

2. **データセット依存性**
   - 一部モデル（特にjpre-xs系）で顕著な性能変動
   - 本番環境では実データでの検証が重要

3. **実用性の向上**
   - より現実的な削除対象比率での評価
   - 圧縮率40-50%でもF2スコア0.86以上を達成可能

4. **i4モデルの優位性**
   - 特にruri-re310m-full-small-i4は安定した高性能
   - 閾値の調整により柔軟な運用が可能

日本語RAGシステムにおけるquery-dependent text pruningは、適切なモデル選択により、新しいデータ分布でも高い実用性を維持できることが確認されました。