# リファクタリング検証用ベースライン: jpre-xs-msmarco-ja-minimal_20250730

## 概要

このドキュメントは、2025年1月30日に実施したPruningTrainerのリファクタリング後に学習した`jpre-xs-msmarco-ja-minimal`モデルの評価結果を記録したものです。今後のリファクタリングによる実装変更が学習結果に影響を与えていないかを検証するためのベースラインとして使用します。

## 学習環境

### 実行コマンド
```bash
uv run python scripts/pruning_train.py pruning-config/jpre-xs-msmarco-ja-minimal.yaml
```

### 学習設定
- **ベースモデル**: hotchpotch/japanese-reranker-xsmall-v2
- **データセット**: hotchpotch/wip-msmarco-context-relevance (msmarco-ja-minimal)
- **学習時間**: 約2分
- **出力ディレクトリ**: `./output/jpre-xs-msmarco-ja-minimal_20250730_082653/final_model`

### 実装状態
- **PruningTrainer**: HuggingFace Trainerベースに変更済み
- **pruning_train.py**: PruningHfTrainerを削除し、新PruningTrainerを使用

## 評価結果

### 評価データセット情報
- **データセット**: `pruning-config/pruning_data_ja_v3.json`
- **総クエリ数**: 257
- **総コンテキスト数**: 1,879
- **保持対象**: 691コンテキスト（36.8%）
- **削除対象**: 1,188コンテキスト（63.2%）

### 閾値別詳細結果

| 閾値 | 精度 | 再現率 | F1スコア | F2スコア | F2.5スコア | TP | FP | TN | FN | 圧縮率 |
|------|------|--------|----------|----------|------------|----|----|----|----|--------|
| 0.1 | 36.87% | 100.00% | 0.5388 | 0.7449 | **0.8090** | 691 | 1183 | 5 | 0 | 0.3% |
| 0.2 | 39.04% | 100.00% | 0.5616 | 0.7620 | **0.8228** | 691 | 1079 | 109 | 0 | 5.8% |
| **0.3** | **44.43%** | **99.28%** | **0.6139** | **0.7962** | **0.8483** | **686** | **858** | **330** | **5** | **17.9%** |
| 0.4 | 54.11% | 91.46% | 0.6799 | 0.8037 | **0.8351** | 632 | 536 | 652 | 59 | 37.8% |
| 0.5 | 54.58% | 60.35% | 0.5732 | 0.5910 | 0.5948 | 417 | 347 | 841 | 274 | 59.3% |
| 0.6 | 64.88% | 28.08% | 0.3919 | 0.3167 | 0.3046 | 194 | 105 | 1083 | 497 | 84.1% |
| 0.7 | 70.59% | 6.95% | 0.1265 | 0.0847 | 0.0794 | 48 | 20 | 1168 | 643 | 96.4% |

**※ 最適閾値: 0.3（太字）**

### 最適閾値（0.3）での性能指標

```
誤差行列（Confusion Matrix）:
                予測
実際    削除      保持
削除    330 (TN)  858 (FP)
保持     5 (FN)  686 (TP)

主要指標:
- 精度（Precision）: 44.43%
- 再現率（Recall）: 99.28%
- F1スコア: 0.6139
- F2スコア: 0.7962
- F2.5スコア: 0.8483
- FN（誤削除）: 5
- 圧縮率: 17.9%（1879 → 1544コンテキスト）
```

## リファクタリング検証項目

今後のリファクタリング後、以下の項目を確認してください：

### 1. 主要性能指標の一致
- [ ] 最適閾値が0.3であること
- [ ] F2.5スコアが0.8483±0.01の範囲内
- [ ] FN（誤削除）が5±2の範囲内
- [ ] 再現率が99%以上

### 2. 学習過程の一致
- [ ] 学習時間が2分±30秒
- [ ] 最終損失値が同等レベル
- [ ] 評価損失の推移が類似

### 3. モデル出力の一致
- [ ] 同一入力に対する予測スコアの差が0.05以内
- [ ] 閾値別の結果パターンが類似

## 再現手順

```bash
# 1. 学習実行
uv run python scripts/pruning_train.py pruning-config/jpre-xs-msmarco-ja-minimal.yaml

# 2. 評価実行（F2.5スコア確認）
uv run python scripts/pruning_exec.py \
    -m output/[生成されたディレクトリ]/final_model \
    -j pruning-config/pruning_data_ja_v3.json \
    --thresholds 0.1 0.2 0.3 0.4 0.5 0.6 0.7

# 3. 簡易評価（動作確認）
uv run python scripts/pruning_exec.py \
    -m output/[生成されたディレクトリ]/final_model \
    -j pruning-config/pruning_data_easy_ja.json \
    --thresholds 0.3
```

## 注意事項

1. **乱数シード**: 学習の再現性のため、同一シード（42）を使用
2. **環境差異**: GPUの違いによる微小な差異は許容
3. **評価データ**: 必ず同一の`pruning_data_ja_v3.json`を使用

## まとめ

このベースラインは、PruningTrainerをHuggingFace Trainerベースにリファクタリングした直後の結果です。今後の実装変更時は、このドキュメントの結果と比較して、意図しない性能劣化や挙動変化がないことを確認してください。

特に重要なのは：
- **F2.5スコア: 0.8483**（閾値0.3）
- **FN（誤削除）: 5**
- **再現率: 99.28%**

これらの値が大きく変化した場合は、実装に問題がある可能性があります。