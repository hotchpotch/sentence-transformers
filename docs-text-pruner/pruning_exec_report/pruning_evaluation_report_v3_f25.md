# PruningEncoder性能評価レポート v3.1: F2.5スコアによる誤削除重視評価

## 概要

本レポートは、新しい評価データセット`pruning-config/pruning_data_ja_v3.json`を用いて、18個のPruningEncoderモデルを**F2.5スコア**で再評価した結果です。F2.5スコアは、F2スコアよりもさらに再現率を重視し、**FN（False Negative：重要情報の誤削除）を強く罰する**評価指標です。

### 評価指標の変更理由
- **問題**: 従来のF2スコアでは、FN（誤削除）が多いモデルも高評価される場合があった
- **目標**: FN≈5程度を最良とし、重要情報の保持を最優先
- **解決**: F2.5スコアの採用により、誤削除により厳しいペナルティを課す

### F-betaスコアの計算式
```
F_β = (1 + β²) × (Precision × Recall) / (β² × Precision + Recall)

- F2: β=2（再現率を精度の4倍重視）
- F2.5: β=2.5（再現率を精度の6.25倍重視）
- F3: β=3（再現率を精度の9倍重視）
```

### 評価環境
- **評価スクリプト**: `scripts/pruning_exec.py`
- **データセット**: `pruning-config/pruning_data_ja_v3.json`
  - 総クエリ数: 257
  - 総コンテキスト数: 1,879
  - 保持対象: 691コンテキスト（36.8%）
  - 削除対象: 1,188コンテキスト（63.2%）

## 総合性能比較表（F2.5スコア基準）

| モデル | 最適閾値 | FN | F2.5スコア | F2スコア | 精度 | 再現率 | 圧縮率 | TP | TN | FP | 評価 |
|--------|----------|----|-----------:|---------|------|--------|--------|----|----|-------|------|
| **jpre-base-full-small-en** | 0.2 | 11 | **0.9057** | 0.8752 | 60.7% | 98.4% | 40.4% | 680 | 747 | 441 | **最高F2.5** |
| **jpre-base-full-small** | 0.1 | **6** | **0.9047** | 0.8704 | 58.5% | 99.1% | 37.4% | 685 | 702 | 486 | **最適FN** |
| **ruri-re310m-full-small-i4** | 0.6 | 18 | **0.9034** | 0.8749 | 62.2% | 97.4% | 42.3% | 673 | 779 | 409 | **バランス** |
| **jpre-base-msmarco-ja-small** | 0.3 | 26 | 0.8978 | 0.8718 | 63.3% | 96.2% | 44.0% | 665 | 803 | 385 | 高精度 |
| **jpre-base-msmarco-ja-small-i4** | 0.5 | **5** | 0.8963 | 0.8588 | 55.8% | 99.3% | 34.3% | 686 | 644 | 544 | **理想FN** |
| **ruri-re310m-full-all** | 0.7 | 64 | 0.8948 | 0.8603 | 71.3% | 90.7% | 53.2% | 627 | 935 | 253 | 高圧縮 |
| **jpre-base-full-small-i4** | 0.4 | 15 | 0.8903 | 0.8550 | 56.9% | 97.8% | 36.8% | 676 | 675 | 513 | - |
| **jpre-xs-msmarco-ja-small** | 0.4 | 25 | 0.8848 | 0.8475 | 57.2% | 96.4% | 39.3% | 666 | 689 | 499 | - |
| **jpre-xs-msmarco-ja-small-i4reverse** | 0.4 | 33 | 0.8713 | 0.8393 | 56.9% | 95.2% | 38.5% | 658 | 690 | 498 | **新追加** |
| **jpre-xs-msmarco-ja-small-i4(新)** | 0.7 | **4** | 0.8704 | 0.8239 | 48.9% | 99.4% | 25.0% | 687 | 470 | 718 | **最小FN** |
| **jpre-base-full-all** | 0.3 | 52 | 0.8845 | 0.8470 | 63.4% | 92.5% | 44.1% | 639 | 819 | 369 | - |
| **jpre-xs-full-small-i4** | 0.4 | **7** | 0.8683 | 0.8219 | 49.0% | 99.0% | 25.6% | 684 | 475 | 713 | 低精度 |
| **jpre-base-full-all-fixed** | 0.4 | 86 | 0.8670 | 0.8236 | 66.6% | 87.6% | 52.5% | 605 | 884 | 304 | - |
| **jpre-xs-msmarco-ja-minimal** | 0.4 | 59 | 0.8486 | 0.8037 | 54.1% | 91.5% | 37.8% | 632 | 652 | 536 | - |
| **jpre-xs-msmarco-ja-small-i4(旧)** | 0.45 | **0** | 0.8445 | 0.7858 | 42.3% | 100% | 13.1% | 691 | 246 | 942 | 極端 |
| **jpre-xs-full-all** | 0.4 | 533 | 0.2365 | 0.2441 | 33.5% | 22.9% | 74.9% | 158 | 874 | 314 | 不良 |

## FN（誤削除）に着目した分析

### FN≤7の推奨モデル（重要情報保持重視）

| 順位 | モデル | FN | F2.5 | 精度 | 再現率 | 圧縮率 | 特徴 |
|------|--------|-------|------|------|--------|--------|------|
| 1 | **jpre-base-full-small** | 6 | 0.9047 | 58.5% | 99.1% | 37.4% | F2.5とFNのバランス最良 |
| 2 | **jpre-base-msmarco-ja-small-i4** | 5 | 0.8963 | 55.8% | 99.3% | 34.3% | 理想的なFN数 |
| 3 | jpre-xs-msmarco-ja-small-i4(新) | 4 | 0.8704 | 48.9% | 99.4% | 25.0% | 最小FNだが精度低 |
| 4 | jpre-xs-full-small-i4 | 7 | 0.8683 | 49.0% | 99.0% | 25.6% | 許容範囲のFN |

### FNグループ別の傾向

| FNグループ | モデル数 | 平均F2.5 | 平均精度 | 平均再現率 | 特徴 |
|-----------|---------|---------|---------|------------|------|
| FN≤10 | 5 | 0.8832 | 52.8% | 99.1% | 情報保持最優先、精度犠牲 |
| FN=11-30 | 4 | 0.8981 | 60.8% | 97.1% | **最適バランス帯** |
| FN=31-100 | 5 | 0.8783 | 63.0% | 91.0% | 高精度だが情報損失リスク |
| FN>100 | 2 | 0.5518 | 50.0% | 55.2% | 実用性低い |

## 実用シナリオ別推奨（F2.5基準）

### シナリオ1: 重要情報保持最優先（医療・金融・法務・アーカイブ）
**第1推奨**: jpre-base-full-small（閾値0.1）
- FN: 6（極めて少ない）
- F2.5: 0.9047（高い）
- 再現率: 99.1%
- 圧縮率: 37.4%（実用的）

**第2推奨**: jpre-base-msmarco-ja-small-i4（閾値0.5）
- FN: 5（理想的）
- F2.5: 0.8963
- 再現率: 99.3%
- 圧縮率: 34.3%

### シナリオ2: バランス重視（一般ビジネス）
**推奨**: jpre-base-full-small-en（閾値0.2）
- FN: 11（許容範囲）
- F2.5: 0.9057（最高）
- 精度/再現率: 60.7%/98.4%
- 圧縮率: 40.4%（効率的）

### シナリオ3: 高精度重視（ノイズ除去優先）
**推奨**: ruri-re310m-full-small-i4（閾値0.6）
- FN: 18（やや多い）
- F2.5: 0.9034（高い）
- 精度: 62.2%（高め）
- 圧縮率: 42.3%

### シナリオ4: 高圧縮重視（ストレージ制約）
**推奨**: jpre-base-msmarco-ja-small（閾値0.3）
- FN: 26（許容可能）
- F2.5: 0.8978
- 精度: 63.3%（高い）
- 圧縮率: 44.0%

## 技術的推奨事項

### 1. 閾値調整によるFN制御
```python
# FN目標値に基づく閾値調整戦略
def adjust_threshold_for_target_fn(model, target_fn=5):
    """
    目標FN数に近づけるための閾値調整
    - FN > target_fn: 閾値を下げる（より保守的に）
    - FN < target_fn: 閾値を上げる（より積極的に）
    """
    thresholds = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7]
    best_threshold = None
    min_diff = float('inf')
    
    for threshold in thresholds:
        current_fn = evaluate_model(model, threshold)['FN']
        diff = abs(current_fn - target_fn)
        if diff < min_diff:
            min_diff = diff
            best_threshold = threshold
    
    return best_threshold
```

### 2. F2.5スコアの実装
```python
def f_beta_score(precision, recall, beta=2.5):
    """
    F-betaスコアの計算
    beta=2.5: 再現率を精度の6.25倍重視
    """
    if precision + recall == 0:
        return 0
    beta_squared = beta ** 2
    return (1 + beta_squared) * (precision * recall) / (beta_squared * precision + recall)
```

### 3. モニタリング指標（更新版）
- **F2.5スコア**: 0.89以上を目標
- **FN（誤削除）**: 5±2を理想とする
- **再現率**: 98%以上を維持
- **圧縮率**: 用途に応じて30-45%

## 結論

F2.5スコアによる再評価により、以下が明らかになりました：

1. **FN制御の重要性**
   - FN=5-7のモデルが最適なバランスを実現
   - jpre-base-full-smallとjpre-base-msmarco-ja-small-i4が理想的

2. **評価指標の影響**
   - F2→F2.5により、高再現率モデルの順位が上昇
   - FN>30のモデルは相対的に評価が低下

3. **実用的推奨**
   - 重要情報保持が必須の用途：FN≤10のモデルを選択
   - 一般用途：FN=10-30の範囲でバランスを取る
   - 圧縮率重視：FNの許容値を事前に定義

4. **閾値戦略**
   - 低閾値（0.1-0.2）：FN最小化、情報保持優先
   - 中閾値（0.3-0.5）：バランス型運用
   - 高閾値（0.6-0.7）：積極的圧縮、精度重視

5. **新規追加モデル（i4reverse）**
   - jpre-xs-msmarco-ja-small-i4reverseは、F2.5=0.8713（閾値0.4）で中位の性能
   - FN=33と適度な誤削除数で、バランスの取れた選択肢

日本語RAGシステムにおいて、**重要情報の誤削除（FN）を最小化**することは、システムの信頼性に直結します。F2.5スコアを用いることで、この観点からより適切なモデル選択が可能になりました。